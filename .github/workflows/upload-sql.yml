name: Upload SQL Files to Azure Synapse

on:
  workflow_dispatch

jobs:
  upload-sql-files:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Upload SQL Files to Azure Synapse
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Execute PowerShell Script
        run: |
            $localFolderPath = "C:\Users\Satyakumar_Surisetti\Documents\sqlfiles"

            $storageAccountName = "satyadldemo"
            $storageAccountKey = "qfzI4S8ydhvdIGLrNLAAOhD735FpbQCmzuUMCHzId9Te4n9gR+FVyDWBB9o7GZKMl66UyPB5l8Tj+AStzjTewA=="
            $containerName = "satyadlfs"

            $context = New-AzStorageContext -StorageAccountName $storageAccountName -StorageAccountKey $storageAccountKey

            Get-ChildItem -Path $localFolderPath -Recurse | ForEach-Object {
                $blobPath = $_.FullName.Replace($localFolderPath, "").TrimStart("\")
                $blobName = $_.Name
                Set-AzStorageBlobContent -Container $containerName -File $_.FullName -Blob $blobPath/$blobName -Context $context
            }
